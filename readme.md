S57Reader - комплекс программ для упрощения геометрии векторных карт методом построения "мостиков" между ними и последующим упрощением.

Проект оформлен в виде трех отдельных приложений, каждое из которых выполняет свою отдельную функцию.
 
Почему три отдельных приложения, а не одно?

1. Комплекс проще отлаживать, поскольку генерируются промежуточные результаты работы.

2. Такая архитектура построения комплекса позволяет использовать его более гибко. Запуская эти приложения в различной последовательности, можно получить различные результаты, которые можно использовать в ГИС-приложениях. Также возможно использование любого приложения для решения других задач в качестве промежуточной стадии обработки.

___Системные требования___

1. Установленные и собранные библиотеки GDAL 2.1.0, boost 1.55, GTest.
2. Visual Studio 2013 или новее.
3. ГИС-приложение - желательно QGIS, но можно и любое другое с поддержкой S-57 и SHP.
4. Установленный CMake.

___Сборка на Debian Linux___

В Debian по-умолчанию установлен GDAL версии 1.X, поэтому GDAL 2.1.0 требуется установить вручную. Инструкции по установке находятся в README в корне папки GDAL.

Boost по-умолчанию включен в дистрибутив Debian, поэтому устанавливать его не нужно

cmake .

make -j12

___Сборка на Windows 7 x64___

Сгенерировать проект Visual Studio в CMake

Собрать проект в Visual Studio

___Splitter___

Программа Splitter реализует следующий алгоритм работы:

1. Считывает несколько файлов, представленных в любом формате, поддерживаемом библиотекой GDAL.

2. Генерирует сетку, шаг которой рассчитывается автоматически для исходной геометрии.

3. Делит исходную геометрию сеткой на тайлы. Для каждого тайла создаются два атрибута - уникальный индекс тайла и группа тайла. Тайлы относятся к одной группе, если получены из одного и того же полигона.

4.  Тайлы, находящиеся внутри исходных полигонов и не пересекающие их границы, выбрасываются.

5. Полученные тайлы сохраняются в файл любого формата, поддерживаемого GDAL.

Результат работы Splitter:

![alt text](https://github.com/vladimir-inoz/maputils/blob/test_readme/stage1.PNG)

___ClasterizeByCentroids___

1.  Считывает несколько файлов, представленных в любом формате, поддерживаемом GDAL. Типичные входные файлы - это тайлы, сгенерированные программой Splitter.

2. Кластеризует полигоны каждой из карт на N кластеров по координатам центроидов. Если центроид находится вне полигона, то он "притягивается" к ближайшей точке полигона.

3. Номер кластера, к которому принадлежит данный полигон, записывается как новый атрибут геометрии в исходном файле. Изменения в исходных файлах можно просмотреть в QGIS в режиме редактирования атрибутов.

Результат работы ClasterizeByCentroids показан ниже. На рисунке полигоны, принадлежащие к одному и тому же кластеру, имеют одинаковый цвет.

![alt text](https://github.com/vladimir-inoz/maputils/blob/test_readme/stage2.PNG)

___Bridges___

1. Считывает несколько файлов, представленных в любом формате, поддерживаемом GDAL. Типичная входная информация - кластеры, сгенерированные ClasterizeByCentroids.

2. Для полигонов каждого файла рассчитываются центроиды так же, как и в программе ClasterizeByCentroids.

3. Генерируется граф, вершинами которого являются центроиды полигонов, а ребра соединяют эти вершины. Каждое ребро имеет вес, равный расстоянию между вершинами. Ребро строится только в том случае, если расстояние не превышает заданное пользователем значение.\

4. Для полученного графа генерируется минимальное остовное дерево по алгоритму Краскала (используется реализация алгоритма из библиотеки Boost).

5.  Центроиды соединяются "мостиками" по ребрам минимального остовного дерева. Мостик генерируется как буферизованный отрезок, ширина буфера которого рассчитывается как минимальный из двух радиусов вписанных в полигоны окружностей.

6.  Если в исходном файле у геометрий есть атрибут group типа Integer, то геометрии одной группы мостиками не соединяются, поскольку они изначально принадлежали к одному полигону, и соединять их мостиками не имеет смысла.

7. Каждая пара групп тайлов соединяется только одним мостиком с минимальной площадью.

8.  "Мостики" сохраняются в файл любого формата, который поддерживается GDAL.

Результат работы приложения Bridges показан ниже.

![alt text](https://github.com/vladimir-inoz/maputils/blob/test_readme/stage3.PNG)


___Решение исходой задачи с использованием bash___

Описанные выше приложение не выполняют объединение и упрощение полигонов, поскольку данный функционал уже реализован в приложении ogr2ogr, входящего в комплект поставки библиотеки GDAL.

Для полного выполнения алгоритма по упрощению геометрии островов требуется написать скрипт для ОС, в которой запускается софт. Ниже приведен пример скрипта для Linux.

```
#Переходим в целевую папку
cd S57Maps &&
#Очищаем папку
rm *.shp
rm *.shx rm *.dbf
#Переводим исходную карту в формат Shapefile
ogr2ogr source.shp source.s57 -f "ESRI Shapefile"
#Разделяем регулярной сеткой на тайлы
Splitter source.s57 LNDARE "ESRI Shapefile" tiles.shp
#Кластеризуем тайлы по расположению центроидов
ClasterizeByCentroids tiles.shp tiles 10
#Создаем мостики
for i in {0..9} do
	Bridges claster_$i.shp claster_$i "ESRI Shapefile" bridges_$i.shp
done
#Соединяем мостики в один файл
for f in bridges_*.shp do
	ogr2ogr -update -append appended.shp $f -f "ESRI Shapefile"
done
ogr2ogr -update -append -skipfailures appended.shp source.s57 -f "S57" "LNDARE"
#Склеиваем полигоны
ogr2ogr merged.shp appended.shp -dialect sqlite -sql "SELECT ST_Union (geometry) AS geometry
#Упрощаем геометрию
ogr2ogr result.shp merged.shp -simplify 0.00005
#Показываем результат
qgis result.shp source.s57
```
Пример для Windows
```
::Очищаем папку 
del * /q

::Разделяем регулярной сеткой на тайлы
Splitter %1 "ESRI Shapefile" splitted.shp

::Кластеризуем тайлы по расположению центроидов
ClasterizeByCentroids splitted.shp splitted 10

::Создаем мостики
FOR /L %G IN (0,1,9) DO Bridges claster_%G.shp claster_%G "ESRI Shapefile"

::Соединяем мостики в один файл
FOR %G IN (bridges_*.shp) DO ogr2ogr -update -append appended.shp %G -f "ESRI Shapefile"
ogr2ogr -update -append -skipfailures appended.shp source.s57 -f "S57" "LNDARE"

::Склеиваем полигоны
ogr2ogr merged.shp appended.shp -dialect sqlite -sql "SELECT ST_Union(geometry) AS geometry

::Упрощаем геометрию
ogr2ogr result.shp merged.shp -simplify 0.00005

::Показываем результат
qgis result.shp source.s57
```
